<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Trip App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #B3E5FC; background-image: url('https://www.transparenttextures.com/patterns/clouds.png'); background-attachment: fixed; font-family: 'Roboto', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .btn-active:active { transform: scale(0.95); opacity: 0.9; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .fixed-bg-icon { pointer-events: none; z-index: 0; }
        select, input, textarea { transition: border-color 0.2s; }
        .day-selector-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .day-selector-item.active { background-color: #0288D1; color: white; transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); border: none; }
        .day-selector-item.inactive { background-color: rgba(255, 255, 255, 0.85); color: #546E7A; border: 1px solid rgba(255, 255, 255, 0.5); backdrop-filter: blur(4px); }
        #login-modal { position: fixed; inset: 0; z-index: 100; background: rgba(179, 229, 252, 0.95); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { muji: { bg: '#F5F5F7', card: '#FFFFFF', text: '#37474F', accent: '#546E7A', sub: '#78909C' } } } } }
    </script>
</head>
<body class="text-muji-text antialiased pb-24">

    <div id="login-modal">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-4/5 max-w-sm text-center">
            <div class="text-5xl mb-4">âœˆï¸</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">æ­¡è¿ä½¿ç”¨ Trip App</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹è¼¸å…¥æ‚¨çš„æ—…éŠä»£ç¢¼ä»¥é–‹å§‹</p>
            <input type="text" id="trip-id-input" placeholder="ä¾‹å¦‚: Amy_Japan" class="w-full bg-gray-50 p-4 rounded-xl text-center font-bold text-lg outline-none border-2 border-transparent focus:border-blue-400 mb-4 transition-all">
            <button onclick="login()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">é–‹å§‹æ—…ç¨‹</button>
        </div>
    </div>

    <header class="fixed top-0 w-full bg-white/90 backdrop-blur-md z-50 shadow-sm border-b border-gray-200">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold tracking-widest text-muji-accent cursor-pointer" id="app-title">TRIP <span class="font-light">APP</span></h1>
            <div class="flex items-center gap-2">
                <span id="user-display" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold"></span>
                <button onclick="fetchItinerary()" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full"><i class="fas fa-sync"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto pt-16 px-4">
        <section id="tab-plan" class="tab-content active">
            <div class="flex justify-between items-center mb-2 mt-2"><h2 class="text-2xl font-bold text-gray-800 drop-shadow-sm">è¡Œç¨‹è¡¨</h2><span id="sync-status" class="text-xs text-gray-600 font-medium"></span></div>
            <div id="day-navigator" class="flex overflow-x-auto gap-3 py-2 mb-4 hide-scrollbar -mx-4 px-4 sticky top-[60px] z-40 pb-4"><div class="text-sm text-gray-500 pl-2 font-bold">è¼‰å…¥ä¸­...</div></div>
            <div id="itinerary-list" class="space-y-6 pb-4 min-h-[300px]"><div class="text-center py-10 text-gray-500 bg-white/60 rounded-2xl backdrop-blur-sm shadow-sm">è³‡æ–™è¼‰å…¥ä¸­...</div></div>
        </section>

        <section id="tab-wallet" class="tab-content">
            <h2 class="text-2xl font-bold mb-6 mt-2 text-gray-800 drop-shadow-sm">è¨˜å¸³</h2>
            <div class="bg-muji-accent text-white rounded-2xl p-5 shadow-lg mb-8 relative overflow-hidden">
                <i class="fas fa-calculator absolute -right-5 -bottom-5 text-white opacity-10 text-9xl"></i>
                <div class="relative z-10">
                    <div class="mb-4"><div class="text-xs opacity-80 mb-1">åŒ¯ç‡ (1 JPY =)</div><div class="text-4xl font-mono font-bold flex items-center"><input type="number" id="exchange-rate" value="0.215" step="0.001" class="bg-transparent border-b border-white/30 w-48 focus:outline-none pr-5" onchange="updateRate()"> <span class="text-lg -ml-2">TWD</span></div></div>
                    <div class="bg-white/10 rounded-xl p-3 flex items-center backdrop-blur-sm"><span class="text-lg mr-2 font-light">Â¥</span><input type="text" id="calc-input" placeholder="500+200*3" oninput="calculate()" inputmode="text" class="w-full bg-transparent text-white placeholder-white/50 focus:outline-none font-mono text-xl"><button onclick="calculate()" class="text-white px-3 text-xl"><i class="fas fa-equals"></i></button></div>
                    <div id="calc-result" class="text-right text-sm mt-2 opacity-80 h-5 font-mono"></div>
                </div>
            </div>
            <div class="bg-white/95 backdrop-blur-md rounded-2xl p-5 shadow-sm mb-8 border border-white/60">
                <h3 class="text-sm font-bold text-muji-sub mb-4">æ–°å¢è¨˜å¸³</h3>
                <div class="flex gap-4 mb-4"><div class="w-1/3 relative"><select id="expense-category" class="w-full h-full bg-gray-50/80 rounded-xl text-sm px-3 py-3 appearance-none outline-none border border-transparent focus:border-muji-accent text-gray-700"><option value="food">ğŸ± é¤é£²</option><option value="shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="transport">ğŸš‡ äº¤é€š</option><option value="ticket">ğŸ« é–€ç¥¨</option><option value="stay">ğŸ¨ ä½å®¿</option><option value="other">ğŸ“¦ å…¶ä»–</option></select><div class="absolute right-2 top-3.5 pointer-events-none text-gray-400 text-xs"><i class="fas fa-chevron-down"></i></div></div><input type="text" id="expense-item" placeholder="å“é …åç¨±" class="w-2/3 bg-gray-50/80 rounded-xl p-3 text-sm outline-none border border-transparent focus:border-muji-accent"></div>
                <div class="grid grid-cols-2 gap-4 mb-4"><div class="relative"><select id="expense-currency" class="w-full bg-gray-50/80 rounded-xl p-3 text-sm appearance-none outline-none border border-transparent focus:border-muji-accent font-bold text-muji-accent"><option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option><option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option><option value="USD">ğŸ‡ºğŸ‡¸ USD</option></select><div class="absolute right-3 top-4 pointer-events-none text-gray-400 text-xs"><i class="fas fa-chevron-down"></i></div></div><div class="relative"><select id="expense-payment" class="w-full bg-gray-50/80 rounded-xl p-3 text-sm appearance-none outline-none border border-transparent focus:border-muji-accent text-gray-700"><option value="cash">ğŸ’´ ç¾é‡‘</option><option value="card">ğŸ’³ ä¿¡ç”¨å¡</option><option value="mobile">ğŸ“± Pay</option><option value="suica">ğŸ§ ICå¡</option></select><div class="absolute right-3 top-4 pointer-events-none text-gray-400 text-xs"><i class="fas fa-chevron-down"></i></div></div></div>
                <div class="mb-4 relative"><input type="number" id="expense-amount" placeholder="æ¶ˆè²»é‡‘é¡" class="w-full bg-gray-50/80 rounded-xl p-3 pl-4 text-base outline-none border border-transparent focus:border-muji-accent font-mono" inputmode="decimal"></div>
                <div class="mb-4"><label class="flex items-center justify-center gap-2 bg-gray-50/80 border border-dashed border-gray-300 rounded-xl p-4 text-sm cursor-pointer text-gray-500 hover:bg-gray-100 transition-colors" id="photo-label-container"><i class="fas fa-camera text-muji-accent"></i><span id="photo-label">ä¸Šå‚³æ”¶æ“š (è‡ªå‹•å£“ç¸®)</span><input type="file" id="expense-photo" accept="image/*" capture="environment" class="hidden" onchange="handlePhotoUpload(this, 'expense')"></label></div>
                <button onclick="addExpense()" id="btn-submit-expense" class="w-full bg-muji-sub text-white py-3.5 rounded-xl font-bold shadow-md btn-active hover:bg-muji-accent transition-colors text-base"><i class="fas fa-plus mr-1"></i> è¨˜éŒ„ä¸¦åŒæ­¥</button>
            </div>
            <div class="bg-gray-800 text-white rounded-2xl p-5 shadow-md mb-8 flex justify-between items-center"><div><div class="text-xs opacity-70 mb-1">ç›®å‰ç´¯ç©æ”¯å‡º</div><div class="text-sm font-bold">Total Spent (TWD)</div></div><div class="text-4xl font-mono font-bold tracking-tight">$<span id="total-spent">0</span></div></div>
            <h3 class="text-sm font-bold text-muji-sub mb-4 px-1">æ¶ˆè²»æ˜ç´°</h3>
            <div id="expense-list" class="space-y-4 pb-8"></div>
        </section>

        <section id="tab-lists" class="tab-content">
            <h2 class="text-2xl font-bold mb-6 mt-2 text-gray-800 drop-shadow-sm">å¿…è²·èˆ‡å¾…è¾¦</h2>
            <div class="bg-white/95 backdrop-blur-md rounded-2xl p-5 shadow-sm mb-8 border border-white/60">
                <div class="flex gap-3 mb-3"><div class="relative w-1/3"><select id="list-category" class="w-full bg-gray-50/80 rounded-xl p-3 text-sm appearance-none outline-none text-gray-600"><option value="buy">ğŸ›ï¸ å¿…è²·</option><option value="bring">ğŸ’ å¿…å¸¶</option><option value="gift">ğŸ ä¼´æ‰‹ç¦®</option><option value="todo">âœ… å¾…è¾¦</option></select><i class="fas fa-chevron-down absolute right-3 top-3.5 text-xs text-gray-400 pointer-events-none"></i></div><input type="text" id="list-input" placeholder="ä¾‹å¦‚: è–¯æ¢ä¸‰å…„å¼Ÿ" class="w-2/3 bg-gray-50/80 rounded-xl p-3 text-sm outline-none placeholder-gray-400"></div>
                <div class="mb-3"><label class="flex items-center justify-center gap-2 bg-gray-50/80 border border-dashed border-gray-300 rounded-xl p-3 text-xs cursor-pointer text-gray-500 hover:bg-gray-100 transition-colors" id="list-photo-label-container"><i class="fas fa-camera text-muji-accent"></i> <span id="list-photo-label">åŠ å…¥åœ–ç‰‡ (é¸å¡«)</span><input type="file" id="list-photo" accept="image/*" class="hidden" onchange="handlePhotoUpload(this, 'list')"></label></div>
                <button onclick="addList()" id="btn-add-list" class="w-full bg-muji-accent text-white py-3.5 rounded-xl font-bold shadow-sm btn-active mt-1"><i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
            </div>
            <div class="flex justify-between items-end mb-3 px-1"><h3 class="text-sm font-bold text-muji-sub">æ¸…å–®é …ç›®</h3><span class="text-[10px] text-gray-500" id="list-count"></span></div>
            <div id="lists-container" class="grid grid-cols-2 gap-4 pb-8"></div>
        </section>

        <section id="tab-journal" class="tab-content">
            <h2 class="text-2xl font-bold mb-6 mt-2 text-gray-800 drop-shadow-sm">æ—…éŠæ—¥èªŒ</h2>
            <div class="bg-white/95 backdrop-blur-md rounded-2xl p-5 shadow-sm mb-8 border border-white/60">
                <h3 class="text-sm font-bold text-muji-sub mb-3">è¨˜éŒ„ç¾å¥½æ™‚åˆ»</h3>
                <div class="relative mb-3"><select id="journal-date" class="w-full bg-gray-50/80 rounded-xl p-3 text-sm appearance-none outline-none border border-transparent focus:border-muji-accent text-gray-700"><option value="">é¸æ“‡æ—¥æœŸ...</option></select><div class="absolute right-3 top-3.5 pointer-events-none text-gray-400 text-xs"><i class="fas fa-chevron-down"></i></div></div>
                <textarea id="journal-text" rows="3" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼æœ‰è¶£çš„äº‹ï¼Ÿ" class="w-full bg-gray-50/80 rounded-xl p-3 text-sm outline-none border border-transparent focus:border-muji-accent mb-3"></textarea>
                <div class="mb-3"><label class="flex items-center justify-center gap-2 bg-gray-50/80 border border-dashed border-gray-300 rounded-xl p-3 text-xs cursor-pointer text-gray-500 hover:bg-gray-100 transition-colors" id="journal-photo-label-container"><i class="fas fa-camera text-muji-accent"></i> <span id="journal-photo-label">åŠ å…¥ç…§ç‰‡ (é¸å¡«)</span><input type="file" id="journal-photo" accept="image/*" class="hidden" onchange="handlePhotoUpload(this, 'journal')"></label></div>
                <button onclick="addJournal()" id="btn-add-journal" class="w-full bg-muji-accent text-white py-3.5 rounded-xl font-bold shadow-sm btn-active mt-1"><i class="fas fa-pen mr-1"></i> å¯«å…¥æ—¥èªŒ</button>
            </div>
            <div id="journal-container" class="space-y-6 pb-8"><div class="text-center py-10 text-gray-500 bg-white/60 rounded-2xl backdrop-blur-sm shadow-sm">æš«ç„¡æ—¥èªŒ</div></div>
        </section>

        <section id="tab-info" class="tab-content">
            <h2 class="text-2xl font-bold mb-6 mt-2 text-gray-800 drop-shadow-sm">å¸¸ç”¨è³‡è¨Š</h2>
            <div id="weather-card" class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-3xl p-6 shadow-lg mb-8 text-white relative overflow-hidden cursor-pointer transform transition-transform hover:scale-[1.02]" onclick="getWeather()">
                <i class="fas fa-cloud fixed-bg-icon absolute -right-4 -bottom-4 text-white opacity-20 text-[100px]"></i>
                <div class="relative z-10 flex justify-between items-center">
                    <div><div class="flex items-center gap-2 mb-1 opacity-90"><i class="fas fa-location-arrow text-xs"></i><span class="text-sm font-bold" id="weather-loc">å®šä½ä¸­...</span></div><div class="text-6xl font-bold mb-2 tracking-tighter" id="weather-temp">--Â°</div><div class="text-sm bg-white/20 px-3 py-1 rounded-full inline-block backdrop-blur-sm" id="weather-desc">è¼‰å…¥æ°£è±¡...</div></div>
                    <div class="text-center"><i id="weather-icon" class="fas fa-cloud-sun text-5xl opacity-90"></i><div class="text-[10px] mt-2 opacity-80">é»æ“Šæ›´æ–°</div></div>
                </div>
            </div>
            <h3 class="text-sm font-bold text-muji-sub mb-4 px-1">å…¶ä»–è³‡è¨Š</h3>
            <div id="info-container" class="space-y-4 pb-8"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-200 z-50 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="switchTab('plan')" class="nav-btn active flex-1 text-muji-accent" data-target="plan"><i class="fas fa-calendar-alt text-xl mb-1 block"></i><span class="text-[10px]">è¡Œç¨‹</span></button>
            <button onclick="switchTab('wallet')" class="nav-btn flex-1 text-gray-400" data-target="wallet"><i class="fas fa-wallet text-xl mb-1 block"></i><span class="text-[10px]">è¨˜å¸³</span></button>
            <button onclick="switchTab('lists')" class="nav-btn flex-1 text-gray-400" data-target="lists"><i class="fas fa-check-square text-xl mb-1 block"></i><span class="text-[10px]">æ¸…å–®</span></button>
            <button onclick="switchTab('journal')" class="nav-btn flex-1 text-gray-400" data-target="journal"><i class="fas fa-book-open text-xl mb-1 block"></i><span class="text-[10px]">æ—¥èªŒ</span></button>
            <button onclick="switchTab('info')" class="nav-btn flex-1 text-gray-400" data-target="info"><i class="fas fa-info-circle text-xl mb-1 block"></i><span class="text-[10px]">è³‡è¨Š</span></button>
        </div>
    </nav>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby9XgpzQDPmkoKWB0D-bdt_RfZS0NXcG3d5KCPnSfLggvKQiZ_TvLCGgnnsUKygSqUL/exec'; 

        let appData = { itinerary: [], expenses: [], lists: [], info: [], journal: [], exchangeRate: 0.215 };
        let expenseCompressedImage = null;
        let listCompressedImage = null;
        let journalCompressedImage = null;
        let activeDayIndex = 0; 
        
        let TRIP_ID = localStorage.getItem('trip_id') || "";

        window.onload = function() {
            if(TRIP_ID) {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('user-display').innerText = TRIP_ID;
                initializeApp();
            } else {
                document.getElementById('login-modal').style.display = 'flex';
            }
            
            document.getElementById('trip-id-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') login();
            });

            let listClickCount = 0;
            document.getElementById('app-title').onclick = function() {
                listClickCount++;
                if(listClickCount === 5) { if(confirm('è¦ç™»å‡ºä¸¦åˆ‡æ›å¸³è™Ÿå—ï¼Ÿ')) { localStorage.removeItem('trip_id'); location.reload(); } listClickCount = 0; }
            };
        };

        function login() {
            const input = document.getElementById('trip-id-input').value.trim();
            if(!input) { alert('è«‹è¼¸å…¥ä»£ç¢¼'); return; }
            TRIP_ID = input;
            localStorage.setItem('trip_id', TRIP_ID);
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('user-display').innerText = TRIP_ID;
            initializeApp();
        }

        function initializeApp() {
            const cached = localStorage.getItem('tripData_' + TRIP_ID);
            if(cached) {
                appData = JSON.parse(cached);
                renderAll();
            }
            const rateEl = document.getElementById('exchange-rate'); if(rateEl) rateEl.value = appData.exchangeRate || 0.215; 
            updateRate();
            getWeather();
            if(GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) fetchItinerary();
        }

        function saveData() { localStorage.setItem('tripData_' + TRIP_ID, JSON.stringify(appData)); }
        function renderAll() { renderItinerary(); renderExpenses(); renderLists(); renderInfo(); renderJournal(); }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => { btn.classList.remove('text-muji-accent', 'text-gray-400'); btn.className = btn.dataset.target === id ? 'nav-btn flex-1 text-muji-accent' : 'nav-btn flex-1 text-gray-400'; });
            if(id === 'journal') updateJournalDateSelect();
        }

        function fetchItinerary() {
            const status = document.getElementById('sync-status'); status.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            fetch(`${GOOGLE_SCRIPT_URL}?uid=${encodeURIComponent(TRIP_ID)}`)
                .then(res => res.json())
                .then(data => {
                    if(data.itinerary) appData.itinerary = data.itinerary;
                    if(data.expenses) appData.expenses = data.expenses;
                    if(data.lists) appData.lists = data.lists;
                    if(data.info) appData.info = data.info;
                    if(data.journal) appData.journal = data.journal;
                    
                    if(data.rate) {
                        const fixedRate = parseFloat(data.rate).toFixed(3);
                        appData.exchangeRate = parseFloat(fixedRate);
                        const rateEl = document.getElementById('exchange-rate');
                        if(rateEl) rateEl.value = fixedRate;
                        updateRate();
                    }

                    saveData(); renderAll();
                    status.innerText = 'å®Œæˆ'; setTimeout(() => status.innerText = '', 2000);
                }).catch(err => { console.error(err); status.innerText = 'å¤±æ•—'; });
        }

        // ã€æ–°åŠŸèƒ½ã€‘è¨ˆç®—æ˜ŸæœŸå¹¾
        function getWeekDay(dateStr) {
            if(!dateStr || dateStr.length < 5) return '';
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            try {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    return `(${days[d.getDay()]})`;
                }
            } catch(e) {}
            return '';
        }

        // --- Render Functions ---
        function renderItinerary() {
            const container = document.getElementById('itinerary-list'); const navContainer = document.getElementById('day-navigator');
            if(!appData.itinerary || !appData.itinerary.length) { container.innerHTML = '<div class="text-center py-10 text-gray-500 bg-white/60 rounded-2xl">æš«ç„¡è¡Œç¨‹è³‡æ–™</div>'; navContainer.innerHTML = ''; return; }
            navContainer.innerHTML = appData.itinerary.map((day, idx) => {
                const isActive = idx === activeDayIndex;
                let rawDate = String(day.date || ""); 
                let dateDisplay = rawDate;
                let weekDay = getWeekDay(rawDate); // å–å¾—æ˜ŸæœŸ

                try {
                    if(rawDate.length > 10) { const d = new Date(rawDate); dateDisplay = !isNaN(d.getTime()) ? (d.getMonth()+1)+'/'+d.getDate() : rawDate.substring(0,5); }
                    else { const p = rawDate.split(/[-/]/); if(p.length>=3) dateDisplay = parseInt(p[1])+'/'+parseInt(p[2]); }
                } catch(e) { dateDisplay = rawDate.substring(0,5); }
                
                // é¡¯ç¤ºæ—¥æœŸ + æ˜ŸæœŸ (å°å­—)
                return `<div onclick="switchDay(${idx})" class="day-selector-item ${isActive?'active':'inactive'} flex-shrink-0 w-16 h-16 rounded-xl flex flex-col items-center justify-center cursor-pointer shadow-sm mx-1">
                    <span class="text-[10px] font-bold opacity-70 mb-0.5">${day.day.replace('D','Day ')}</span>
                    <span class="text-base font-bold leading-none">${dateDisplay}</span>
                    <span class="text-[10px] opacity-70 mt-0.5">${weekDay}</span>
                </div>`;
            }).join('');
            
            const currentDay = appData.itinerary[activeDayIndex]; if (!currentDay) return;
            
            let rawFullDate = String(currentDay.date || "");
            let fullDate = rawFullDate;
            let bigWeekDay = getWeekDay(rawFullDate); // å¤§æ¨™é¡Œçš„æ˜ŸæœŸ

            try { if(rawFullDate.length>10) { const d = new Date(rawFullDate); if(!isNaN(d.getTime())) fullDate = d.getFullYear()+'/'+(d.getMonth()+1)+'/'+d.getDate(); } } catch(e){}
            
            const dayHeader = `<div class="bg-white/95 backdrop-blur-md p-5 rounded-3xl shadow-sm border border-white/60 mb-6 animate-[fadeIn_0.3s_ease-in-out]"><div class="flex items-center justify-between"><div><h3 class="text-2xl font-bold text-gray-800">${currentDay.title}</h3><div class="text-sm text-gray-500 mt-1 flex items-center"><i class="far fa-calendar-alt mr-2 text-muji-accent"></i> ${fullDate} <span class="ml-2 font-bold text-blue-500">${bigWeekDay}</span></div></div><div class="bg-gray-100 text-gray-500 px-3 py-1.5 rounded-full flex items-center justify-center font-bold shadow-inner text-sm whitespace-nowrap">${currentDay.day.replace('D','Day ')}</div></div></div>`;
            
            const eventsHtml = currentDay.events.map((evt, idx) => {
                let timeline = 'bg-gray-300', icon = '<i class="fas fa-circle text-[8px]"></i>', type = 'normal', grad = '', bgIcon = '', mainIcon = '';
                if (evt.type === 'flight') { type = 'flight'; timeline = 'bg-blue-500 ring-4 ring-blue-100'; icon = '<i class="fas fa-plane text-xs text-white"></i>'; }
                else if (evt.type === 'transport') { type = 'colored'; timeline = 'bg-teal-500 ring-4 ring-teal-100'; icon = '<i class="fas fa-train-subway text-xs text-white"></i>'; grad = 'from-teal-400 to-cyan-500'; bgIcon = 'fa-train-subway'; mainIcon = 'fa-train-subway'; }
                else if (evt.type === 'car') { type = 'colored'; timeline = 'bg-orange-400 ring-4 ring-orange-100'; icon = '<i class="fas fa-car text-xs text-white"></i>'; grad = 'from-orange-400 to-amber-500'; bgIcon = 'fa-car'; mainIcon = 'fa-car'; }
                else if (evt.type === 'walk') { type = 'colored'; timeline = 'bg-green-500 ring-4 ring-green-100'; icon = '<i class="fas fa-walking text-xs text-white"></i>'; grad = 'from-emerald-400 to-green-500'; bgIcon = 'fa-walking'; mainIcon = 'fa-walking'; }
                else if (evt.type === 'important') { timeline = 'bg-red-500 ring-4 ring-red-100'; icon = '<i class="fas fa-star text-xs text-white"></i>'; }
                let html = '';
                if (type === 'flight') {
                    let [dep, arr] = evt.content.includes('->') ? evt.content.split('->') : [evt.content, ''];
                    html = `<div class="mb-2"><span class="text-sm font-bold text-gray-700 inline-block mb-2 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-lg shadow-sm border border-white/50">${evt.timeRange}</span></div><div class="bg-gradient-to-br from-blue-500 to-cyan-500 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden transform transition-all hover:scale-[1.01]"><i class="fas fa-plane fixed-bg-icon absolute -right-4 -bottom-8 text-white opacity-10 text-[120px] transform -rotate-12"></i><div class="flex justify-between items-center relative z-10 mb-6 mt-2"><div class="text-center"><div class="text-2xl font-bold mb-1">${dep}</div><div class="text-xs opacity-80 bg-blue-600/30 px-2 py-0.5 rounded-full inline-block">Dep</div></div><div class="flex flex-col items-center px-2 shrink-0"><div class="text-sm font-bold mb-1 opacity-90">${evt.subtitle.split('|')[0]||''}</div><div class="flex items-center w-full"><div class="h-[2px] bg-white/40 flex-1 relative"><i class="fas fa-plane absolute right-0 -top-[7px] text-sm"></i></div></div></div><div class="text-center"><div class="text-2xl font-bold mb-1">${arr}</div><div class="text-xs opacity-80 bg-blue-600/30 px-2 py-0.5 rounded-full inline-block">Arr</div></div></div>${evt.subtitle.includes('|')?`<div class="mt-4 flex items-start text-xs bg-white/20 rounded-xl p-3 backdrop-blur-sm relative z-10 leading-relaxed border border-white/10"><i class="fas fa-info-circle mr-2 mt-0.5 shrink-0"></i><span>${evt.subtitle.split('|')[1]}</span></div>`:''}</div>`;
                } else if (type === 'colored') {
                    html = `<div class="bg-gradient-to-br ${grad} rounded-3xl p-6 text-white shadow-lg relative overflow-hidden transform transition-all hover:scale-[1.01]"><i class="fas ${bgIcon} fixed-bg-icon absolute -right-4 -bottom-6 text-white opacity-10 text-[100px] transform -rotate-12"></i>${evt.link?`<a href="${evt.link}" target="_blank" class="absolute top-4 right-4 text-white/80 hover:text-white transition-colors z-20"><i class="fas fa-external-link-alt"></i></a>`:''}<div class="relative z-10 mb-2"><span class="text-xs font-bold bg-white/20 px-2 py-1 rounded backdrop-blur-sm inline-block">${evt.timeRange}</span></div><div class="relative z-10 flex items-start"><div class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center mr-3 shrink-0 backdrop-blur-sm"><i class="fas ${mainIcon} text-sm"></i></div><h4 class="text-lg font-bold leading-tight pt-1.5 shadow-sm">${evt.content}</h4></div>${evt.subtitle?`<div class="mt-4 text-xs bg-white/20 p-3 rounded-xl border border-white/10 flex items-start leading-relaxed relative z-10 backdrop-blur-sm"><i class="fas fa-info-circle mr-2 mt-0.5 opacity-80 shrink-0"></i><span>${evt.subtitle}</span></div>`:''}</div>`;
                } else {
                    html = `<div class="bg-white/95 backdrop-blur-sm rounded-2xl p-5 shadow-sm border border-white/60 relative">${evt.link?`<a href="${evt.link}" target="_blank" class="absolute top-4 right-4 text-gray-300 hover:text-muji-accent transition-colors"><i class="fas fa-external-link-alt"></i></a>`:''}<div class="flex items-start"><div class="bg-gray-100 text-gray-500 w-10 h-10 rounded-full flex items-center justify-center mr-4 shrink-0"><i class="fas fa-map-marker-alt text-sm"></i></div><div class="flex-1 pt-0.5"><div class="text-xs font-bold text-muji-accent mb-1 bg-gray-50 inline-block px-2 py-0.5 rounded">${evt.timeRange}</div><h4 class="text-base font-bold text-gray-800 leading-tight mb-1">${evt.content}</h4></div></div>${evt.subtitle?`<div class="mt-3 text-xs text-gray-500 bg-gray-50 p-3 rounded-lg border border-gray-100 flex items-start leading-relaxed"><i class="fas fa-info-circle mr-2 mt-0.5 text-gray-400 shrink-0"></i><span>${evt.subtitle}</span></div>`:''}</div>`;
                }
                return `<div class="relative pl-8 pb-8 ${idx===currentDay.events.length-1?'':'border-l-2 border-gray-200'} ml-4"><span class="absolute -left-[9px] top-1 w-5 h-5 rounded-full flex items-center justify-center shadow-sm ${timeline} z-10 ring-[3px] ring-white">${icon}</span><div class="-mt-2">${html}</div></div>`;
            }).join('');
            container.innerHTML = `<div>${dayHeader}<div class="mt-4">${eventsHtml}</div></div>`;
        }
        function switchDay(i) { activeDayIndex=i; renderItinerary(); document.getElementById('day-navigator').children[i]?.scrollIntoView({behavior:'smooth', inline:'center'}); }

        // --- Actions (ä¿®æ”¹ï¼šåŠ ä¸Š userId) ---
        function addExpense() {
            const item = document.getElementById('expense-item').value, amount = document.getElementById('expense-amount').value, category = document.getElementById('expense-category').value, payment = document.getElementById('expense-payment').value, currency = document.getElementById('expense-currency').value;
            const btn = document.getElementById('btn-submit-expense');
            if(!item || !amount) { alert('è«‹è¼¸å…¥å…§å®¹èˆ‡é‡‘é¡'); return; }
            btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';
            let twd = Math.round(currency==='JPY'? amount*appData.exchangeRate : (currency==='USD'? amount*32.5 : amount));
            const newEx = { id: Date.now(), date: new Date().toLocaleDateString(), item, amount, twd, category, payment, currency, photo: expenseCompressedImage };
            appData.expenses.unshift(newEx); saveData(); renderExpenses();
            if(GOOGLE_SCRIPT_URL) {
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ userId: TRIP_ID, item, amount, twd, category, payment, currency, image: expenseCompressedImage }) })
                .then(res=>res.json()).finally(() => { btn.disabled=false; btn.innerHTML='<i class="fas fa-plus mr-1"></i> è¨˜éŒ„ä¸¦åŒæ­¥'; document.getElementById('expense-item').value=''; document.getElementById('expense-amount').value=''; expenseCompressedImage=null; document.getElementById('photo-label').innerText='ä¸Šå‚³æ”¶æ“š (è‡ªå‹•å£“ç¸®)'; document.getElementById('photo-label-container').classList.remove('text-muji-accent', 'border-muji-accent'); });
            } else { btn.disabled=false; btn.innerHTML='<i class="fas fa-plus mr-1"></i> è¨˜éŒ„ä¸¦åŒæ­¥'; }
        }
        function renderExpenses() {
            let total=0, c=document.getElementById('expense-list');
            if(!appData.expenses.length) { c.innerHTML='<div class="text-center text-gray-400 py-6 text-sm bg-white/60 rounded-2xl">å°šæœªæœ‰è¨˜å¸³è³‡æ–™</div>'; document.getElementById('total-spent').innerText='0'; return; }
            c.innerHTML = appData.expenses.map(ex => {
                total+=parseInt(ex.twd)||0;
                let icon='fa-box', color='bg-gray-100', payIcon='fa-coins';
                if(ex.category==='food') { icon='fa-utensils'; color='bg-orange-100 text-orange-500'; }
                else if(ex.category==='shopping') { icon='fa-shopping-bag'; color='bg-pink-100 text-pink-500'; }
                else if(ex.category==='transport') { icon='fa-train-subway'; color='bg-teal-100 text-teal-600'; }
                else if(ex.category==='stay') { icon='fa-bed'; color='bg-blue-100 text-blue-500'; }
                if(ex.payment==='card') payIcon='fa-credit-card'; else if(ex.payment==='mobile') payIcon='fa-mobile-alt'; else if(ex.payment==='suica') payIcon='fa-train';
                const left = ex.photo ? `<img src="${ex.photo}" class="w-10 h-10 rounded-full object-cover border border-gray-100 shadow-sm">` : `<div class="w-10 h-10 rounded-full ${color} flex items-center justify-center shadow-sm"><i class="fas ${icon} text-sm"></i></div>`;
                return `<div class="bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-sm flex items-center justify-between border border-white/50 mb-2"><div class="flex items-center gap-4">${left}<div><div class="font-bold text-gray-700 text-sm flex items-center gap-2">${ex.item}<span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded flex items-center gap-1"><i class="fas ${payIcon} text-[9px]"></i></span></div><div class="text-[10px] text-gray-400 mt-0.5">${ex.date}</div></div></div><div class="flex items-center gap-3"><div class="text-right"><div class="text-base font-bold font-mono text-gray-800">${ex.currency==='TWD'?'NT$':(ex.currency==='USD'?'$':'Â¥')}${ex.amount}</div><div class="text-[10px] text-gray-400 font-mono">â‰ˆ NT$${ex.twd}</div></div><button onclick="deleteExpense('${ex.id}')" class="text-gray-300 hover:text-red-500 p-2 transition-colors"><i class="fas fa-trash-alt"></i></button></div></div>`;
            }).join('');
            document.getElementById('total-spent').innerText=total.toLocaleString();
        }
        function deleteExpense(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { appData.expenses=appData.expenses.filter(e=>e.id!=id); saveData(); renderExpenses(); if(GOOGLE_SCRIPT_URL && String(id).startsWith('server_')) fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:JSON.stringify({userId: TRIP_ID, action:'delete', id})}); } }

        function addList() {
            const input = document.getElementById('list-input'), cat = document.getElementById('list-category').value, btn = document.getElementById('btn-add-list');
            if(!input.value.trim()) return;
            btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';
            const tempId = "temp_" + Date.now();
            appData.lists.unshift({ id: tempId, text: input.value, category: cat, checked: false, photo: listCompressedImage });
            saveData(); renderLists(); 
            if(GOOGLE_SCRIPT_URL) {
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ userId: TRIP_ID, action: 'add_list', category: cat, text: input.value, image: listCompressedImage }) })
                .then(res=>res.json()).then(data=>{ const t = appData.lists.find(l=>l.id===tempId); if(t) t.id=data.id; saveData(); })
                .finally(()=>{ btn.disabled=false; btn.innerHTML='<i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®'; input.value=''; listCompressedImage=null; document.getElementById('list-photo-label').innerText='åŠ å…¥åœ–ç‰‡ (é¸å¡«)'; document.getElementById('list-photo-label-container').classList.remove('text-muji-accent', 'border-muji-accent');});
            } else { btn.disabled=false; btn.innerHTML='<i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®'; input.value=''; }
        }
        function renderLists() {
            const c = document.getElementById('lists-container'), count = document.getElementById('list-count');
            if(!appData.lists.length) { c.innerHTML='<div class="col-span-2 text-center text-gray-400 py-10 text-sm bg-white/60 rounded-2xl">å°šç„¡é …ç›®</div>'; count.innerText=''; return; }
            const sorted = [...appData.lists].sort((a,b)=>a.checked-b.checked);
            count.innerText = `${appData.lists.filter(l=>l.checked).length}/${appData.lists.length} å®Œæˆ`;
            c.innerHTML = sorted.map(item => {
                let badge='bg-gray-100 text-gray-500', name='å…¶ä»–';
                if(item.category==='buy') { badge='bg-pink-100 text-pink-500'; name='å¿…è²·'; }
                else if(item.category==='bring') { badge='bg-blue-100 text-blue-500'; name='å¿…å¸¶'; }
                else if(item.category==='todo') { badge='bg-green-100 text-green-600'; name='å¾…è¾¦'; }
                const isChecked = item.checked;
                const imgHtml = item.photo ? `<img src="${item.photo}" class="w-full aspect-square object-cover rounded-t-xl group-hover:scale-105 transition-transform duration-500">` : `<div class="w-full aspect-square bg-gray-100 rounded-t-xl flex items-center justify-center text-gray-300"><i class="fas fa-image text-3xl"></i></div>`;
                return `<div class="${isChecked?'bg-gray-100 opacity-60':'bg-white'} rounded-xl shadow-sm border border-gray-100 flex flex-col relative group overflow-hidden" onclick="toggleList('${item.id}')">${imgHtml}${isChecked ? '<div class="absolute inset-0 bg-black/10 flex items-center justify-center z-10"><span class="bg-white/80 px-3 py-1 rounded-full text-xs font-bold text-gray-600 shadow-sm">å·²è³¼è²·</span></div>' : ''}<div class="p-3 relative z-20 bg-white"><div class="flex justify-between items-start mb-1"><span class="text-[10px] ${badge} px-1.5 py-0.5 rounded">${name}</span><button onclick="event.stopPropagation();deleteList('${item.id}')" class="text-gray-300 hover:text-red-400"><i class="fas fa-trash-alt text-xs"></i></button></div><div class="${isChecked?'line-through text-gray-400':'text-gray-800'} font-bold text-sm truncate">${item.text}</div></div></div>`;
            }).join('');
        }
        function toggleList(id) { const i=appData.lists.find(l=>l.id==id); if(i){ i.checked=!i.checked; saveData(); renderLists(); if(GOOGLE_SCRIPT_URL && String(id).startsWith('L_')) fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:JSON.stringify({userId: TRIP_ID, action:'toggle_list', id})}); } }
        function deleteList(id) { if(confirm('åˆªé™¤æ­¤é …ç›®ï¼Ÿ')) { appData.lists=appData.lists.filter(l=>l.id!=id); saveData(); renderLists(); if(GOOGLE_SCRIPT_URL && String(id).startsWith('L_')) fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:JSON.stringify({userId: TRIP_ID, action:'delete_list', id})}); } }

        function renderJournal() {
            const c = document.getElementById('journal-container');
            const data = appData.journal || [];
            if(!data.length) { c.innerHTML='<div class="text-center py-10 text-gray-500 bg-white/60 rounded-2xl">å°šç„¡æ—¥èªŒ</div>'; return; }
            c.innerHTML = data.map(j => {
                const imgHtml = j.photo ? `<img src="${j.photo}" class="w-full h-48 object-cover rounded-xl mt-3 shadow-sm border border-gray-100">` : '';
                let dayLabel = j.date;
                // å¼·åˆ¶è½‰å­—ä¸²é¿å…æ¯”å°æ™‚å‡ºéŒ¯
                const itinDay = appData.itinerary.find(d => { 
                    const dDate = String(d.date || "");
                    const jDate = String(j.date || "");
                    if(dDate.length > 5) return dDate.includes(jDate) || new Date(dDate).toLocaleDateString().includes(jDate); 
                    return dDate === jDate; 
                });
                if(itinDay) dayLabel = `${itinDay.day.replace('D','Day ')} - ${j.date}`;
                return `<div class="bg-white/95 backdrop-blur-md p-5 rounded-3xl shadow-sm border border-white/60 relative group"><div class="flex justify-between items-start mb-2"><div class="flex items-center gap-2"><span class="bg-muji-accent text-white text-xs px-2 py-1 rounded-md font-bold">${dayLabel}</span></div><button onclick="deleteJournal('${j.id}')" class="text-gray-300 hover:text-red-400 p-1"><i class="fas fa-trash-alt"></i></button></div><div class="text-gray-700 leading-relaxed whitespace-pre-line text-sm">${j.text}</div>${imgHtml}</div>`;
            }).join('');
        }
        function updateJournalDateSelect() {
            const select = document.getElementById('journal-date'); if(!select || !appData.itinerary.length) return;
            select.innerHTML = '<option value="">é¸æ“‡æ—¥æœŸ...</option>';
            appData.itinerary.forEach(day => {
                let val = String(day.date || ""); // å¼·åˆ¶è½‰å­—ä¸²
                try { if(val.length > 10) { const d = new Date(val); if(!isNaN(d.getTime())) val = (d.getMonth()+1) + '/' + d.getDate(); } } catch(e){}
                const option = document.createElement('option'); option.value = val; option.text = `${day.day.replace('D','Day ')} (${val}) - ${day.title}`; select.appendChild(option);
            });
        }
        function addJournal() {
            const date = document.getElementById('journal-date').value, text = document.getElementById('journal-text').value, btn = document.getElementById('btn-add-journal');
            if(!date || !text) { alert('è«‹é¸æ“‡æ—¥æœŸä¸¦è¼¸å…¥å…§å®¹'); return; }
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const newJ = { id: "temp_" + Date.now(), date: date, text: text, photo: journalCompressedImage };
            appData.journal.unshift(newJ); saveData(); renderJournal();
            document.getElementById('journal-text').value = ''; journalCompressedImage = null; document.getElementById('journal-photo-label').innerText = 'åŠ å…¥ç…§ç‰‡ (é¸å¡«)'; document.getElementById('journal-photo-label-container').classList.remove('text-muji-accent', 'border-muji-accent');
            if(GOOGLE_SCRIPT_URL) {
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ userId: TRIP_ID, action: 'add_journal', date: date, text: text, image: journalCompressedImage }) })
                .then(res=>res.json()).then(data => { const t = appData.journal.find(j => j.id === newJ.id); if(t) t.id = data.id; saveData(); })
                .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-pen mr-1"></i> å¯«å…¥æ—¥èªŒ'; });
            } else { btn.disabled = false; btn.innerHTML = '<i class="fas fa-pen mr-1"></i> å¯«å…¥æ—¥èªŒ'; }
        }
        function deleteJournal(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { appData.journal = appData.journal.filter(j => j.id != id); saveData(); renderJournal(); if (GOOGLE_SCRIPT_URL && String(id).startsWith('J_')) fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ userId: TRIP_ID, action: 'delete_journal', id: id }) }); } }

        function handlePhotoUpload(input, type) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const max = 800; let w=img.width, h=img.height; if(w>max){h=Math.round(h*(max/w)); w=max;}
                        const cvs = document.createElement('canvas'); cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(img,0,0,w,h);
                        const data = cvs.toDataURL('image/jpeg', 0.7);
                        if(type==='expense') { expenseCompressedImage=data; document.getElementById('photo-label').innerText='æº–å‚™å®Œæˆ'; document.getElementById('photo-label-container').classList.add('text-muji-accent', 'border-muji-accent'); }
                        else if(type==='list') { listCompressedImage=data; document.getElementById('list-photo-label').innerText='åœ–ç‰‡å·²å°±ç·’'; document.getElementById('list-photo-label-container').classList.add('text-muji-accent', 'border-muji-accent'); }
                        else if(type==='journal') { journalCompressedImage=data; document.getElementById('journal-photo-label').innerText='ç…§ç‰‡å·²å°±ç·’'; document.getElementById('journal-photo-label-container').classList.add('text-muji-accent', 'border-muji-accent'); }
                    };
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function updateRate(){ const r=document.getElementById('exchange-rate'); if(r){ appData.exchangeRate=parseFloat(r.value)||0.215; saveData(); calculate(); renderExpenses(); } }
        function calculate(){ const i=document.getElementById('calc-input'), r=document.getElementById('calc-result'); if(!i||!r)return; let v=i.value; if(!v){r.innerText='';return;} try{ v=v.replace(/[\uff10-\uff19]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xfee0)).replace(/[\uff0b]/g,'+'); const jpy=eval(v.replace(/[^0-9+\-*/().]/g,'')); if(isFinite(jpy)) r.innerText=`= ${jpy} JPY â‰ˆ ${Math.round(jpy*appData.exchangeRate)} TWD`; }catch(e){r.innerText='...';} }
        function getWeather(){ 
            const l=document.getElementById('weather-loc'), t=document.getElementById('weather-temp'), d=document.getElementById('weather-desc'), i=document.getElementById('weather-icon');
            if(!navigator.geolocation){d.innerText="ç„¡å®šä½æ¬Šé™";return;} l.innerText="å®šä½ä¸­...";
            navigator.geolocation.getCurrentPosition(p=>{
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true&timezone=auto`)
                .then(r=>r.json()).then(data=>{ t.innerText=`${Math.round(data.current_weather.temperature)}Â°`; l.innerText="ç›®å‰ä½ç½®"; d.innerText=getWeatherInfo(data.current_weather.weathercode).desc; i.className=`fas ${getWeatherInfo(data.current_weather.weathercode).icon} text-5xl opacity-90`; })
                .catch(()=>{d.innerText="æ°£è±¡æš«ç„¡æ³•ç”¨";});
            }, ()=>{l.innerText="å®šä½å¤±æ•—";});
        }
        function getWeatherInfo(c){ if(c===0)return{desc:"æ™´æœ—",icon:"fa-sun"}; if(c<=3)return{desc:"å¤šé›²",icon:"fa-cloud-sun"}; if(c>=95)return{desc:"é›·é›¨",icon:"fa-bolt"}; return{desc:"é™°é›¨",icon:"fa-cloud-rain"}; }
        function renderInfo() {
            const c = document.getElementById('info-container'), d = appData.info||[];
            if(!d.length) { c.innerHTML='<div class="text-center mt-6 text-gray-400 text-xs">æç¤ºï¼šåœ¨ Google Sheets æ–°å¢ "Info" åˆ†é </div>'; return; }
            const g={}; d.forEach(i=>{ const k=i.category||'å…¶ä»–'; if(!g[k])g[k]=[]; g[k].push(i); });
            c.innerHTML = Object.keys(g).map(k=>`<div><h3 class="text-sm font-bold text-muji-sub mb-3 pl-1">${k}</h3><div class="space-y-3">${g[k].map(i=>`<${i.link?'a':'div'} ${i.link?`href="${i.link}" target="_blank"`:''} class="bg-white/90 backdrop-blur-sm p-4 rounded-xl border border-white/50 flex items-center gap-4 ${i.link?'btn-active':''}"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center shrink-0 text-muji-accent"><i class="fas ${i.icon||'fa-info-circle'}"></i></div><div class="flex-1 min-w-0"><div class="text-sm font-bold text-gray-800 truncate">${i.title}</div><div class="text-xs text-gray-500 truncate">${i.value}</div></div>${i.link?'<i class="fas fa-chevron-right text-gray-300 text-xs"></i>':''}</${i.link?'a':'div'}>`).join('')}</div></div>`).join('');
        }
    </script>
</body>
</html>